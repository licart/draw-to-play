<html>
<head>
<meta charset="UTF-8" />
<style>
html, body {margin:0; padding:0;  width:100%; height:100%; overflow:hidden;} 
canvas { display:block; background-color: MidnightBlue ; cursor: pointer;}
	  #canvas:active { cursor: crosshair;}

  .rigidbody { position: absolute; left: 0; top: 0;}
    #body { position: absolute; left: 0; top: 0; text-align: center ; display:none; }
#body iframe{width:220px; height:160px; pointer-events: none; } 
</style>

    <script type="text/javascript" src="Box2dWeb-2.1.a.3.min.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
</head>
<body>
	<video  id="myVideo2"    style="display:none;" autoplay  ><source  src="" ></video>
<canvas id="canvas" tabindex='0'></canvas> 

    <div id="body" ><iframe id ="tv"  src=""  frameborder="0"></iframe> </div>  
		
                <div style="position: absolute; top:95%; left: 45%; width: 45%; height: 8%;vertical-align: top;text-align: center; background-color: lavender;" >
                   <button  onclick="fixe=true; dyna=false">Fixed</button>                   
                    <button  onclick="pause();">Pause</button>
                    <button  onclick="eraseline();">Erase</button><label for="rangeinput">zoom</label>
<input id="rangeinput" style="width: 80px; " type="range"  value=30  min="25" max="35"/>
                    <button onclick="resetScene();">Reset</button>
					<button  onclick="dyna=true; fixe=false">Dynamic</button>                   
                </div>

	<script type="text/javascript">
	
var b2Vec2 = Box2D.Common.Math.b2Vec2
    , b2AABB = Box2D.Collision.b2AABB
    , b2BodyDef = Box2D.Dynamics.b2BodyDef
    , b2Body = Box2D.Dynamics.b2Body
    , b2FixtureDef = Box2D.Dynamics.b2FixtureDef
    , b2Fixture = Box2D.Dynamics.b2Fixture
    , b2World = Box2D.Dynamics.b2World
    , b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape
    , b2CircleShape = Box2D.Collision.Shapes.b2CircleShape
    , b2DebugDraw = Box2D.Dynamics.b2DebugDraw
    , b2MouseJointDef =  Box2D.Dynamics.Joints.b2MouseJointDef
    , b2RevoluteJointDef =  Box2D.Dynamics.Joints.b2RevoluteJointDef
    , b2Shape = Box2D.Collision.Shapes.b2Shape
    ;
var b2PrismaticJoint = Box2D.Dynamics.Joints.b2PrismaticJointDef,
   b2FilterData = Box2D.Dynamics.b2FilterData,
      b2Transform = Box2D.Common.Math.b2Transform;
  var b2BuoyancyController = Box2D.Dynamics.Controllers.b2BuoyancyController;
var b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef;
var b2ContactListener = Box2D.Dynamics.b2ContactListener;

 
        var world = new b2World(new b2Vec2(0, 9.8), true);
	
  var canvas = document.getElementById("canvas");
   var context = canvas.getContext("2d");
  ctx = document.getElementById("canvas").getContext('2d');
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;
			

var run = true;	   
var drawing = false;
var PTM=30;
var previousMouseX = 0;
var previousMouseY = 0;
var u = new b2Vec2(0, 0);
var anchor = [];
var bodies = [];
var d = 1.0;
var ctx;
var points = [];
    var mouseJoint;
	var trans1 = false;
	var trap;
	
	var fixe;
	var dyna;
		var dessin = false; 
			var ligne = false;
	
  var  mouseX =0;
   var mouseY =0;           
var viewCenterPixel = { x:window.innerWidth/1.5, y:window.innerHeight/2.5 };	

	
					
        var imgT = new Image();
        imgT.src = "tire.png";
        var img = new Image();
        img.src = "fr24.png";
        var imga = new Image();
        imga.src = "FR24AR.jpg";
        var imgb = new Image();
        imgb.src = "euronews_arabic.jpg";
        var img2 = new Image();
        img2.src = "hajj.png";
        var img2a = new Image();
        img2a.src = "coranfrtv.jpg";
        var img2b = new Image();
        img2b.src = "islamchannel.jpg";
        var img3 = new Image();
        img3.src = "pencil.png";
        var img4 = new Image();
        img4.src = "arfr.png";
        var eur = new Image();
        eur.src = "EURORAD.png";
        var fri = new Image();
        fri.src = "FRINFO.png";
        var rfi = new Image();
        rfi.src = "rfint.png";
			var audio = new Audio("sfxe.wav");	
			var audio2 = new Audio("pick.wav");audio2.volume=0.5;
			var audioA = new Audio("hitMedium.wav");audioA.volume=0.3;

var video22 = document.getElementById('myVideo2');

  
				PTM = window.innerHeight / 25;
var canvasOffset = { x: 0, y: 0 }; 
  
function myRound(val,places) { var c = 1; for (var i = 0; i < places; i++)  c *= 10; return Math.round(val*c)/c; }        
function getWorldPointFromPixelPoint(pixelPoint) {
    var pos = { x: (pixelPoint.x - canvasOffset.x)/PTM, y: (pixelPoint.y - (canvas.height - canvasOffset.y))/PTM };
    return pos;
}
function setViewCenterWorld(b2vecpos, instantaneous) {
    var currentViewCenterWorld = getWorldPointFromPixelPoint( viewCenterPixel );
    var toMoveX = b2vecpos.x - currentViewCenterWorld.x;
    var toMoveY = -b2vecpos.y - currentViewCenterWorld.y;
    var fraction = instantaneous ? 1 : 0.25;
    canvasOffset.x -= myRound(fraction * toMoveX * PTM, 0);
    canvasOffset.y += myRound(fraction * toMoveY * PTM, 0);
}

function zoomIn() {
    var currentViewCenterWorld = getWorldPointFromPixelPoint( viewCenterPixel );
    PTM *= 1.05;
    var newViewCenterWorld = getWorldPointFromPixelPoint( viewCenterPixel );
    canvasOffset.x += (newViewCenterWorld.x-currentViewCenterWorld.x) * PTM;
    canvasOffset.y -= (newViewCenterWorld.y-currentViewCenterWorld.y) * PTM; 
}
function zoomOut() {
    var currentViewCenterWorld = getWorldPointFromPixelPoint( viewCenterPixel );
    PTM /= 1.05;
    var newViewCenterWorld = getWorldPointFromPixelPoint( viewCenterPixel );
    canvasOffset.x += (newViewCenterWorld.x-currentViewCenterWorld.x) * PTM;
    canvasOffset.y -= (newViewCenterWorld.y-currentViewCenterWorld.y) * PTM;  
}



var interval;
$("#rangeinput").mousedown(function(event){
  interval = setInterval(function(){
        //draw(ctx, ($("#rangeinput").val()));&& 
		if ($("#rangeinput").val() > 30 ){zoomIn(); return false} 
		if ($("#rangeinput").val() < 30 ){zoomOut(); return false} 
      //  $("#output").html($("#rangeinput").val());
    //draw(ctx, this.value);

   },70);
});

$("#rangeinput").mouseup(function(event){
    clearInterval(interval);
});

function Rigid(world, data) {
this.data = data;
     fixDef  = new b2FixtureDef();
        fixDef.density = data.density != null ? data.density : 1.0;
        fixDef.friction = data.friction != null ? data.friction : 0.5;
        fixDef.restitution = data.restitution != null ? data.restitution : 0.2;
	fixDef.filter.groupIndex = data.filter || 0;;
 fixDef.isSensor = data.sensor || false;	
        this.bodyDef = new b2BodyDef();
  this.bodyDef.angle = data.angle || 0;
        this.bodyDef.type = data.type == "static" ? b2Body.b2_staticBody : b2Body.b2_dynamicBody;
         this.bodyDef.position = new b2Vec2(data.x/2 , data.y/2 ); 
         this.bodyDef.userData = this || userdata; 
       this.body = world.CreateBody(this.bodyDef);
    switch(data.shape) {
      case "circle":
        fixDef.shape = new b2CircleShape(data.radius);
        break;
      case "polygon":
        fixDef.shape = new b2PolygonShape();  
		fixDef.shape.SetAsArray(data.points,data.points.length);
        break;     
      case "block":     
        fixDef.shape = new b2PolygonShape();
        fixDef.shape.SetAsBox(data.width, data.height);
        break;
    }

    this.body.CreateFixture(fixDef); 
    }

    Rigid.prototype = {
        constructor: Rigid,
        update: function () {
				var angle1 = this.body.GetAngle()*(180/Math.PI);
					  var pos1 = this.body.GetPosition();					  
					  context.save();					  
					  context.fillStyle = this.data.color;
					  context.translate( pos1.x*PTM , pos1.y *PTM );
					  context.rotate( angle1 * (Math.PI/180) );
					  context.translate( -pos1.x*PTM, -pos1.y *PTM);
				if(this.data.color) {					  
      switch(this.data.shape) { 
	  case "block":
					  context.fillRect( this.body.GetPosition().x*PTM-this.data.width*PTM,
                           this.body.GetPosition().y*PTM-this.data.height*PTM,
                           (this.data.width*2)*PTM,
                           (this.data.height*2)*PTM); 
						   break;
        case "circle": 				  					  
		context.beginPath();
					 context.arc(pos1.x * PTM, pos1.y * PTM, this.data.radius * PTM, 0, 2 * Math.PI, false);
					 context.closePath();
					 context.fill();
          break;
        case "polygon":
					  var points = this.data.points; 
					  context.beginPath();
					  context.moveTo(this.body.GetPosition().x * PTM + points[0].x * PTM, this.body.GetPosition().y * PTM + points[0].y * PTM);
				for(var i=1;i<points.length;i++) {						 
					  context.lineTo(points[i].x * PTM + this.body.GetPosition().x* PTM, points[i].y * PTM + this.body.GetPosition().y*PTM);					  
					  }					    
					  context.closePath();					  
					  context.fill();			  					
		break;
      }
					  }
    if(this.data.image) {
      context.drawImage(this.data.image, this.body.GetPosition().x*PTM-this.data.width*PTM,
                           this.body.GetPosition().y*PTM-this.data.height*PTM,
                           (this.data.width*2)*PTM,
                           (this.data.height*2)*PTM);
    }    
	if(this.data.image2) {
          var points2 = this.data.points;      
          for(var i=0+1;i<points2.length;i++) {
            context.drawImage(this.data.image2,
          this.body.GetPosition().x * PTM + points2[0].x , this.body.GetPosition().y* PTM  + points2[0].y ,
		  points2[i].x * PTM + this.body.GetPosition().x   ,points2[i].y * PTM + this.body.GetPosition().y  )
          }
			context.closePath();
    }
	if(this.data.userdata == "box2") {
		  context.drawImage(  video22, this.body.GetPosition().x*PTM-this.data.width*PTM,
                           this.body.GetPosition().y*PTM-this.data.height*PTM,
                           (this.data.width*2)*PTM,
                           (this.data.height*2)*PTM)
   
   
    }
					  context.restore();
			}						
    };
  
		
		
		
	var dddd;
		
	drawcar=false;
CreCar = function (world) {
drawcar=true;
		  truck = new Rigid(world, { color: " rgba(255,165,0, 0.5)", shape: "block", userdata: "box2",   x:5, y:-8, filter: -1, width: 8, height:6});
  rigidBody = new RigidBody(world, {  shapeType: "BOX", el: document.getElementById('body'), width: 220, height: 160, x: 0, y: 0  });
 		 revoluteJoi = new b2RevoluteJointDef();
	  revoluteJoi.bodyA = truck.body; revoluteJoi.bodyB = rigidBody.body;
	  revoluteJoi.localAnchorA = new b2Vec2(0, 0); revoluteJoi.localAnchorB = new b2Vec2(0, 0);
  revoluteJoi.enableLimit = true; world.CreateJoint(revoluteJoi);   
 //rigidBody2 = new RigidBody(world, {  shapeType: "CIRCLE", el: document.getElementById('circ'),radius: 0.3, width: 15, height: 15, x: 30, y: 60  });
 
 var groundFixDef = new b2FixtureDef();
    groundFixDef.shape = new b2PolygonShape();
    groundFixDef.shape.SetAsBox(3, 0.1);
		groundFixDef.density = 1;
		groundFixDef.friction = 0.8;
		groundFixDef.restitution = .2; 
    var groundDef = new b2BodyDef();
    groundDef.type = b2Body.b2_staticBody;
    groundDef.position.Set(2.25, 3.6);
		groundDef.userData = 'rectangle';	
     solo =world.CreateBody(groundDef);
	solo.CreateFixture(groundFixDef);
	
        var bodyDef2 = new b2BodyDef;
		bodyDef2.type = b2Body.b2_dynamicBody;
		bodyDef2.position.Set(12,-2);
		bodyDef2.userData = 'circle2';		
		var fixDef2 = new b2FixtureDef;
		fixDef2.density = 1;
		fixDef2.friction = .9;
		fixDef2.restitution = .2; 
		fixDef2.shape = new b2CircleShape(0.5);		  
        wheel = world.CreateBody(bodyDef2);
		wheel.CreateFixture(fixDef2);
		//
//sol3c = new Rigid(world, { image: imgT, shape: "circle", userdata: "chanel", density : 1,  x:-75, y: 2, radius: 2, width: 2, height:2, video2:"https://archive.org/download/French-Quran/French-quranJuz15alIsraaorBaniIsrail1-AlKahfi74_512kb.mp4" });
 sol3 = new Rigid(world, { image: img, shape: "block", userdata: "chanel", density : 1,  x:40, y: 2, width: 2, height:2, video:"http://www.youtube.com/embed/qKEk1YCOz8Q?modestbranding=1&amp;controls=0&amp;rel=0&autoplay=1&vq=tiny"});
sol3a = new Rigid(world, { image: imga, shape: "block", userdata: "chanel", density : 1,  x:40, y: -1, width: 2, height:2, video:"https://www.youtube.com/embed/55IL8QtH0Ao?modestbranding=1&amp;controls=0&amp;rel=0&autoplay=1&vq=tiny"});
sol3b = new Rigid(world, { image: imgb, shape: "block", userdata: "chanel", density : 1,  x:40, y: -4, width: 2, height:2, video:"https://www.youtube.com/embed/vFgvp3GQgkU?modestbranding=1&amp;controls=0&amp;rel=0&autoplay=1&vq=tiny"});

sol2 = new Rigid(world, { color: "tan", type: "static", shape: "polygon", density: 1, friction: 1, filter:1,
                          points: [ { x: 0, y: 0 }, { x: 0, y: 8 },{ x: -30, y: 8 }, { x: -26, y: 0 }  ], x:-65, y: 22});						  
sol2a = new Rigid(world, { image: img4, shape: "block", type: "static", userdata: "chanel", density: 1, friction: 1,  x:-100, y: 18, width: 2, height:2, video: 'https://www.youtube.com/embed/9awYZBdxB3E?list=PLC98746FB01E013D1&amp;autoplay=1&amp;controls=0&amp;rel=0&amp;vq=tiny'});
	sol2b = new Rigid(world, { image: img2, shape: "block", type: "static", userdata: "chanel", density: 1, friction: 1, x:-100, y: 10, width: 2, height:2, video: 'http://www.youtube.com/embed/lsKg9KpVaKg?modestbranding=1&amp;autoplay=1&amp;controls=0&amp;rel=0&amp;vq=tiny'});  //lsKg9KpVaKg ou D8YHp37-tp0
	sol2c = new Rigid(world, { image: img2a, shape: "block", type: "static", userdata: "chanel", density: 1, friction: 1,  x:-100, y: 2, width: 2, height:2, video: 'https://www.youtube.com/embed/oEI7tyn-nMM?modestbranding=1&amp;controls=0&amp;rel=0&autoplay=1&vq=tiny'});
	sol2d = new Rigid(world, { image: img2b, shape: "block", type: "static", userdata: "chanel", density: 1, friction: 1, x:-100, y: -6, width: 2, height:2, video: 'http://player.sharp-stream.com/islamtv/islamtv.html'});
	sol2e = new Rigid(world, { image: img2, shape: "block", type: "static", userdata: "chanel", density: 1, friction: 1, x:-100, y: -14, width: 2, height:2, video2: 'http://66.226.10.51:8000/SaudiTVArabic'});
			  
						  
 sol0 = new Rigid(world, {color: "#228B22 ", type: "static", shape: "block",  x:20, y: 20, width: 30, height:1}); 
 sol = new Rigid(world, { image: eur, shape: "block", userdata: "chanel", friction: 1, restitution : 0,  x:30, y: 2, width: 2, height:2, video2: 'http://euronews-01.ice.infomaniak.ch/euronews-01.aac', postr: "eurorGR.png"}); 
	sola = new Rigid(world, { image: fri, shape: "block", userdata: "chanel", friction: 1, restitution : 0,  x:30, y: -1, width: 2, height:2, video2: 'http://audio.scdn.arkena.com/11007/franceinfo-lofi32.mp3', postr: "friGR.png"}); 
solb = new Rigid(world, { image: rfi, shape: "block", userdata: "chanel", friction: 1, restitution : 0,  x:30, y: -4, width: 2, height:2, video2: 'http://rfi-monde-24k.scdn.arkena.com/rfimonde.mp3', postr: "rfigrand.jpg"}); 

carh = new Rigid(world, {color: "blue", density : 0.2, shape: "block",  x:9.6, y: 9.2, width: 0.8, height: 0.4}); 
 carb = new Rigid(world, {color: "blue", density : .8, friction: 0.5, restitution : 0.01, shape: "block", filter: -1, x:10, y: 10, width: 2.2, height: 0.5}); 
	  joint_def = new b2RevoluteJointDef();
	  joint_def.bodyA = carb.body; joint_def.bodyB = carh.body;
	  joint_def.localAnchorA = new b2Vec2(0, -0.5); joint_def.localAnchorB = new b2Vec2(-0.4, 0.3);
  joint_def.enableLimit = true; world.CreateJoint(joint_def);   
  
  ax1 = new Rigid(world, {color: "red", density: 1,  shape: "block", angle: Math.PI / 3, x:13 -0.6 * Math.cos(Math.PI / 3), y:  13 - 0.6  * Math.sin(Math.PI / 3), width: 0.4, height: 0.1}); 
  ax2 = new Rigid(world, {color: "red", density: 1, shape: "block", angle: -Math.PI / 3, x: 7 +0.6  * Math.cos(-Math.PI / 3), y: 13 + 0.6 * Math.sin(-Math.PI / 3), width: 0.4, height: 0.1}); 
      prismaticJointDef = new b2PrismaticJoint();
      prismaticJointDef.Initialize(carb.body, ax1.body, ax1.body.GetWorldCenter(), new b2Vec2(Math.cos(Math.PI / 3), Math.sin(Math.PI / 3)));
      prismaticJointDef.lowerTranslation = -.7; prismaticJointDef.upperTranslation = 0;
      prismaticJointDef.enableLimit = true; prismaticJointDef.enableMotor = true;
  spring1 = world.CreateJoint(prismaticJointDef);
      prismaticJointDef.Initialize(carb.body, ax2.body, ax2.body.GetWorldCenter(), new b2Vec2(-Math.cos(Math.PI / 3), Math.sin(Math.PI / 3)));
  spring2 = world.CreateJoint(prismaticJointDef);
	  
  wheel1 = new Rigid(world, {image: imgT, density: 0.9, friction : 6, restitution : .2, shape: "circle", filter: -1, x: ax1.body.GetWorldCenter().x + 13.3 * Math.cos(Math.PI / 3), y: ax1.body.GetWorldCenter().y + 7.9 * Math.sin(Math.PI / 3), radius: 0.7, width: 0.7, height: 0.7}); 
  wheel2 = new Rigid(world, {image: imgT, density: 0.9, friction : 6, restitution : .2, shape: "circle", filter: -1, x: ax2.body.GetWorldCenter().x + 6.8 * Math.cos(-Math.PI / 3), y: ax2.body.GetWorldCenter().y - 7.9 * Math.sin(-Math.PI / 3), radius: 0.7, width: 0.7, height: 0.7}); 
	  revoluteJointDef = new b2RevoluteJointDef();
      revoluteJointDef.enableMotor = true;
      revoluteJointDef.Initialize(ax1.body, wheel1.body, wheel1.body.GetWorldCenter());
  this.motor1 = world.CreateJoint(revoluteJointDef);
      revoluteJointDef.Initialize(ax2.body, wheel2.body, wheel2.body.GetWorldCenter());
  this.motor2 = world.CreateJoint(revoluteJointDef);	
	
} 
    CreCar.prototype = {
        constructor: CreCar,
        update: function () {	
	sol2.update(); sol2a.update(); sol2b.update(); sol2c.update(); sol2d.update(); sol2e.update()
			sol0.update();
			sol.update(); sola.update();	solb.update();
			sol3.update(); sol3a.update(); sol3b.update(); //sol3c.update();
	  carb.update(); carh.update();	wheel1.update(); wheel2.update(); ax1.update();	ax2.update();
truck.update(); rigidBody.update(); //rigidBody2.update();
			
      spring1.SetMaxMotorForce(force + Math.abs(tension * Math.pow(spring1.GetJointTranslation(), 2)));
      spring1.SetMotorSpeed((spring1.GetMotorSpeed() - speed * spring1.GetJointTranslation()) * 0.4);
      spring2.SetMaxMotorForce(force + Math.abs(tension * Math.pow(spring2.GetJointTranslation(), 2)));
      spring2.SetMotorSpeed((spring2.GetMotorSpeed() - speed * spring2.GetJointTranslation()) * 0.4);
      this.motor1.SetMotorSpeed(speed * Math.PI * direction);
      this.motor1.SetMaxMotorTorque(torque);
      this.motor2.SetMotorSpeed(speed * Math.PI * direction);
      this.motor2.SetMaxMotorTorque(torque);
	  
	if(!trans1){
   var pos2 = carb.body.GetPosition();
  var vel2 = carb.body.GetLinearVelocity();
 var futurePos = new b2Vec2( pos2.x + (0.15 * vel2.x), pos2.y + (0.15 * vel2.y) );
    setViewCenterWorld( futurePos ); //;PTM = window.innerHeight / 25; 
	//viewCenterPixel = { x:window.innerWidth/1.5, y:window.innerHeight/2.5 };
	};
	if (trans1){
   var pos = sol0.body.GetPosition();
  var vel = sol0.body.GetLinearVelocity();
 var futurePos2 = new b2Vec2((pos.x-6), (pos.y-11.5)  );
   setViewCenterWorld( futurePos2 ); 
	//viewCenterPixel = { x:window.innerWidth/2, y:window.innerHeight/2}; 
	}
	
	}
	}
	
	  var direction, force, speed, tension, tilt, tiltTorque, torque;
      tension = 800; force = 20; speed = 5; torque = 15; speed = 10; tiltTorque = 100; direction = 0; 
	
			destroycar = function() {
			world.DestroyBody(carb.body); world.DestroyBody(carh.body);	world.DestroyBody(wheel1.body);
			world.DestroyBody(wheel2.body);	world.DestroyBody(ax1.body); world.DestroyBody(ax2.body);
			world.DestroyBody(sol.body); world.DestroyBody(sola.body);world.DestroyBody(solb.body);
			world.DestroyBody(sol2.body); world.DestroyBody(sol2a.body); world.DestroyBody(sol2b.body);
			world.DestroyBody(sol2c.body); world.DestroyBody(sol2d.body); world.DestroyBody(sol2e.body);
			world.DestroyBody(sol3.body); world.DestroyBody(sol3a.body); world.DestroyBody(sol3b.body);
				world.DestroyBody(solo); world.DestroyBody(wheel); world.DestroyBody(truck.body); 
				world.DestroyBody(rigidBody.body); //world.DestroyBody(body33);
				world.DestroyBody(sol0.body); drawcar=false; 
			}
			
			
			
function RigidBody(world, data) {

        var fixDef  = new b2FixtureDef();
        fixDef.density = data.density != null ? data.density : 1.0;
        fixDef.friction = data.friction != null ? data.friction : 0.5;
        fixDef.restitution = data.restitution != null ? data.restitution : 0.2;
        var bodyDef = new b2BodyDef();
		bodyDef.userData = 'rig';	
        bodyDef.type = data.type != null ? data.type : b2Body.b2_dynamicBody;
        this.width = data.width;
        this.height = data.height;
        this.halfWidth = data.width * 0.5;
        this.halfHeight = data.height * 0.5;
        var halfWidth  = this.halfWidth / PTM;
        var halfHeight = this.halfHeight / PTM;
  if (data.shapeType === "BOX") {
    fixDef.shape = new b2PolygonShape();
    fixDef.shape.SetAsBox(halfWidth, halfHeight);
  }
  else if (data.shapeType === "CIRCLE") {
    fixDef.shape = new b2CircleShape();
    fixDef.shape.SetRadius(data.radius);
  }
        var x = (data.x != null ? data.x : this.halfWidth) / PTM;
        var y = (data.y != null ? data.y : this.halfHeight) / PTM;
        bodyDef.position.x = x;
        bodyDef.position.y = y;

        if (data.el != null) {
            this.el = data.el;
        }
        else {
            this.el = document.createElement('div');
        }
        this.el.className += ' rigidbody';
  if (data.shapeType === "BOX") {
    this.el.style.width  = this.width  + 'px';
    this.el.style.height = this.height  + 'px';
  }
  else if (data.shapeType === "CIRCLE") {
    this.el.style.height = this.el.style.width = (data.radius * 2 * PTM) + 'px';
    this.el.style.borderRadius = '50%';
  }
	fixDef.filter.groupIndex = 2;
        this.body = world.CreateBody(bodyDef);
        this.body.CreateFixture(fixDef);
    }
    RigidBody.prototype = {
        constructor: RigidBody,
        update: function () {
            var x = (this.body.GetPosition().x *PTM) - this.halfWidth +canvasOffset.x ;
            var y = (this.body.GetPosition().y *PTM) - this.halfHeight +  canvasOffset.y;
            var r = this.body.GetAngle() * 180 / Math.PI;
            x = Math.abs(x) < 0.00000000001 ? 0 : x;
            y = Math.abs(y) < 0.00000000001 ? 0 : y;
            r = Math.abs(r) < 0.00000000001 ? 0 : r;
            this.el.style.webkitTransform = 'translate(' + x + 'px, ' + y + 'px) rotate(' + r + 'deg) scale(' + 0.055*PTM + ', ' + 0.055*PTM + ')' ;
        }
    };
    canvas.addEventListener('mousemove', onMouseMove, false);    
    canvas.addEventListener('mousedown', onMouseDown, false);    
    canvas.addEventListener('mouseup', onMouseUp, false);		
								
			dddd = new CreCar(world);	
			
  canvasOffset.x = window.innerWidth/2;
   canvasOffset.y = window.innerHeight/2;
	
	 				
	
  var listener = new Box2D.Dynamics.b2ContactListener;
    	 listener.BeginContact = function(contact) {
			 fxA=contact.GetFixtureA();
			 fxB=contact.GetFixtureB();
			 sA=fxA.IsSensor();
			 sB=fxB.IsSensor();// audioA.play();
			if (fxA.GetBody().GetUserData() == "shape" && fxB.GetBody().GetUserData().data.userdata == "chanel"){ 
			var trap = window.setTimeout(function(){ 
		if(contact.GetFixtureB().GetBody().GetUserData().data.video2 != null){
			$("#myVideo2").attr("src", contact.GetFixtureB().GetBody().GetUserData().data.video2).get(0).play();trans1=true; PTM=30;			
}

		if(contact.GetFixtureB().GetBody().GetUserData().data.video != null || contact.GetFixtureB().GetBody().GetUserData().data.postr != null){
    						document.getElementById("body").setAttribute("style", "display:block");
						$("#tv").attr("src", contact.GetFixtureB().GetBody().GetUserData().data.postr);
    		$("#tv").attr("src", contact.GetFixtureB().GetBody().GetUserData().data.video).get(0);trans1=true; PTM=30;}
							  },1500);
        }
		 }		 
    	 listener.EndContact = function(contact) {
         	 fxA=contact.GetFixtureA();
			 fxB=contact.GetFixtureB();
			 sA=fxA.IsSensor();
			 sB=fxB.IsSensor();
			if (fxA.GetBody().GetUserData() == "shape"  ){ 	
			if (contact.GetFixtureB().GetBody().GetUserData().data.video2 == null){		
					  $("#myVideo2").attr("src", ("about:blank"));  trans1=false;}
					  // PTM = window.innerHeight / 25; && contact.GetFixtureB().GetBody().GetUserData().data.video == null  PTM=25;
					 if (contact.GetFixtureB().GetBody().GetUserData().data.video == null){	
					$("#tv").attr("src", ("about:blank"));  document.getElementById("body").setAttribute("style", "display:none !important");
					trans1=false;
					 }
					   //
			//if (contact.GetFixtureB().GetBody().GetUserData().data.video == null){}	
      }
		 }
world.SetContactListener(listener);


			function eraseline() { clearTimeout(trap); trans1=false; //PTM = window.innerHeight / 25; 
					$("#tv").attr("src", ("about:blank")); $("#myVideo2").attr("src", ("about:blank"));
					for(body = world.GetBodyList(); body; body = body.GetNext()) {
					if(body.GetUserData() == "shape") {world.DestroyBody(body);}  else if(body.GetUserData() == "line") {world.DestroyBody(body);  }
					};	}	
 
        function tick() {
           world.Step(1 / 20, 8, 4);		
           
	   if (drawcar) { drawsph(); } 
            world.ClearForces();
        }
		
		
function animate() { if ( run ) window.setTimeout( animate, 1000 / 30 ); tick();}
function pause() { run = !run; if (run)  animate();}

    window['onload'] = function doOnload() {animate(); }
	
 
 
 
	function drawsph(){
     if (drawing) {	 
        var p = new b2Vec2(0, 0);
        p.x = mouseX - previousMouseX;
        p.y = mouseY - previousMouseY;
        if (vecMagnitude(p) !== 0) {
            if (Math.cos(10 / 180 * Math.PI) > vecAngle(p, u)) { setAnchor(previousMouseX, previousMouseY); }
            u.x = p.x;
            u.y = p.y;
        }
        previousMouseX = mouseX,
        previousMouseY = mouseY;    
		} 
							
	 // world.Step(1 / 20, 8, 2);
        canvas.width = canvas.width; // Clear the screen 
        context.clearRect(0,0,canvas.width,canvas.height); 
            //world.DrawDebugData();
			   context.save(); 
			
        context.translate(canvasOffset.x, canvasOffset.y);
			if (drawcar) { dddd.update(); }	
 draw_world(world, ctx); 
        if (  mouseJoint == null && drawing ) {  
		context.drawImage(img3,mouseX ,mouseY ,img.width/4,-img.height/4);
    points.push({ x: mouseX , y: mouseY });
			context.save();
			context.beginPath();
			context.lineWidth = 0.006*(window.innerHeight / 15*PTM);
			context.strokeStyle = "red";
context.lineJoin = context.lineCap = 'round';
			context.moveTo(points[0].x, points[0].y);
    for (var i = 1; i < points.length; i++) { context.lineTo(points[i].x, points[i].y); }
    context.stroke();
	context.restore();
	}
       
       	context.restore();
		

	}
	
	
    function getBodyAtMouse(mPVec2) {
        var aabb = new b2AABB();
        aabb.lowerBound.Set(mPVec2.x - 0.001, mPVec2.y - 0.001);
        aabb.upperBound.Set(mPVec2.x + 0.001, mPVec2.y + 0.001);        
        var selectedBody = null;
        world.QueryAABB(getBodyCB, aabb);
        return selectedBody;
        
        function getBodyCB(fixture) {
            if(fixture.GetBody().GetType() != b2Body.b2_staticBody) {
                if(fixture.GetShape().TestPoint(fixture.GetBody().GetTransform(), mPVec2)) {
                    selectedBody = fixture.GetBody();
                    return false;
                }
            }
            return true;
        }        
    }
	
    function mousePVec2(event) {
        var rect = event.target.getBoundingClientRect();
        return new b2Vec2( (event.pageX - rect.left -canvasOffset.x) / PTM, (event.pageY - rect.top -canvasOffset.y) / PTM );

    }
	
function setAnchor(x, y) { anchor.push(new b2Vec2(x, y)); }
function vecMagnitude(v) { return Math.sqrt(Math.pow(v.x, 2) + Math.pow(v.y, 2)); }
function vecAngle(v1, v2) { return (v1.x * v2.x + v1.y * v2.y) / (vecMagnitude(v1) * vecMagnitude(v2)); }

function createBody() {
    var boxDef = new b2BodyDef();
    boxDef.type = b2Body.b2_dynamicBody;
    boxDef.position.Set(0, 0);   
    var body = world.CreateBody(boxDef);

    for (var i = 0; i < anchor.length - 1; i++) {
        var position = new b2Vec2((anchor[i].x + anchor[i + 1].x) / (PTM*2), (anchor[i].y + anchor[i + 1].y) / (PTM*2));
        var angle = Math.atan2(anchor[i].y - anchor[i + 1].y, anchor[i].x - anchor[i + 1].x);
        var l = vecMagnitude(new b2Vec2(anchor[i].x - anchor[i + 1].x, anchor[i].y - anchor[i + 1].y)) / PTM;

        if(anchor.length == 2 && l < 0.05){ l = 0.05; }

        var boxFixDef = new b2FixtureDef();
        boxFixDef.density = d * l * 0.1;
        boxFixDef.friction = 1;
        boxFixDef.restitution = 0; 
        boxFixDef.shape = new b2PolygonShape();
        boxFixDef.shape.SetAsOrientedBox(l / 2, 0.002*PTM, position, angle);
        body.CreateFixture(boxFixDef);
    }
    body.SetUserData("shape");
    bodies.push(body);
}


function dog_dessiner(x, y)
			{	
				if(ligne)
				{
					ligne.width = x - ligne.x;	ligne.height = y - ligne.y;
						this.bodydef = new b2BodyDef;
						fixdef = new b2FixtureDef;					
						this.bodydef.type = b2Body.b2_staticBody;
						this.bodydef.position.x = ligne.x/PTM  ;
						this.bodydef.position.y = ligne.y/PTM  ;										
						fixdef.friction = 1;						
						fixdef.shape = new b2PolygonShape;
						fixdef.shape.SetAsEdge(new b2Vec2(0,0), new b2Vec2(ligne.width/PTM, ligne.height/PTM));						
						this.body = world.CreateBody(this.bodydef);
						this.body.CreateFixture(fixdef);							
						this.body.SetUserData("line");			
						ligne = {
							x: ligne.x + ligne.width,
							y: ligne.y + ligne.height
						};
					
				}
				else
				{
					ligne = {x: x, y: y};
				}
			}
			function dog_eraseline()
			{
				for(body = world.GetBodyList(); body; body = body.GetNext()) {
					if(body.GetUserData() == "line") {world.DestroyBody(body);}
				}		
			}
			
	
function resetScene() { eraseline(); fixe=false; dyna=false;	if(drawcar) { destroycar();  $("#tv").attr("src", ("about:blank")); $("#myVideo2").attr("src", ("about:blank")); } 
 trans1=false; PTM = window.innerHeight / 25; dddd = new CreCar(world);}
	
	
function draw_world(world, context) {
  for (var b = world.GetBodyList(); b; b = b.GetNext()) {
    for (var f = b.GetFixtureList(); f != null; f = f.GetNext()) {
      var shape = f.GetShape();
      var userdata = b.GetUserData();
      var shapeType = shape.GetType();
      if (isNaN(b.GetPosition().x)) {
        alert('Invalid Position : ' + b.GetPosition().x);
      } else {
 drawShape(b, shape, context);}
      }
    
 
  }
}


function drawShape(body, shape, context) {
  context.beginPath();

  switch (shape.GetType()) {
  case b2Shape.e_circleShape:
    {
if (body.GetUserData() == "circle2" )
				  {	
      var circle = shape;
      var pos = body.GetPosition();
      var r = shape.GetRadius();
      var segments = 16.0;
      var theta = 0.0;
      var dtheta = 2.0 * Math.PI / segments;

      // draw circle
      context.moveTo((pos.x + r) * PTM, pos.y * PTM);

      for (var i = 0; i < segments; i++) {
        var d = new b2Vec2(r * Math.cos(theta), r * Math.sin(theta));
context.fillStyle = "turquoise"; 
  //  context.strokeStyle = "red";
        var v = pos.Copy();
        v.Add(d);
        context.lineTo(v.x * PTM, v.y * PTM);
        theta += dtheta;
      }

      context.lineTo((pos.x + r) * PTM, pos.y * PTM);

      // draw radius line
      context.moveTo(pos.x * PTM, pos.y * PTM);
      var ax = body.GetTransform().R.col1;

      var pos2 = new b2Vec2(pos.x + r * ax.x, pos.y + r * ax.y);
      context.lineTo(pos2.x * PTM, pos2.y * PTM);
    }
  context.fill();
break;
	}
  case b2Shape.e_polygonShape:
    {
if (body.GetUserData() == "shape" || body.GetUserData() == "rectangle" || body.GetUserData() == "line" )
				  {	
      var poly = shape;
      var vert = shape.GetVertices();

      var position = body.GetPosition();

      var tV = position.Copy();
      var a = vert[0].Copy();
      a.MulM(body.GetTransform().R);
      tV.Add(a);
			  context.fillStyle = "red";
			  context.strokeStyle = "red";
			context.lineWidth = 0.002*(window.innerHeight / 15*PTM);
			  if (body.GetUserData() == "rectangle" ){context.lineWidth = 2; context.fillStyle = "olive"; context.strokeStyle = "pink";};
			if (body.GetUserData() == "line" ){context.lineWidth = 0.006*(window.innerHeight / 15*PTM); context.fillStyle = "olive"; context.strokeStyle = "pink";};
			
 
          
 context.lineJoin = context.lineCap = 'round'; 
      context.moveTo(tV.x * PTM, tV.y * PTM);

      for (var i = 0; i < vert.length; i++) {
        var v = vert[i].Copy();
        v.MulM(body.GetTransform().R);
        v.Add(position);
        context.lineTo(v.x * PTM, v.y * PTM);
      }

      context.lineTo(tV.x * PTM, tV.y * PTM);
    }
  context.fill();
  context.stroke();
    break;
	}
  }
 
}
			
	
function onMouseMove(e) {
        var rect = canvas.getBoundingClientRect();
  mouseX = e.pageX - this.offsetLeft- canvasOffset.x;
  mouseY = e.pageY - this.offsetTop- canvasOffset.y;	
         if( mouseJoint == null && dessin && run && fixe && dyna == false) {dog_dessiner(mouseX , mouseY );}
        if ( mouseJoint == null && run && drawing ) { 
var t;
       clearTimeout(t); //Clear restore volume function  //var audio = document.getElementById("audio1");
        audio.play(); audio.volume=0.3;
        t = setTimeout(function(){  //var audio = document.getElementById("audio1");
            audio.volume=0; }, 200);
		}
        var mPVec2 = mousePVec2(event);
        if(mouseJoint) { mouseJoint.SetTarget(new b2Vec2(mPVec2.x , mPVec2.y )) 	
		}
};

function onMouseDown(e) { 
    points.push({ x: mouseX, y: mouseY });
        var mPVec2 = mousePVec2(event);
        var body;        	
        if(body = getBodyAtMouse(mPVec2)) {	
        var md = new b2MouseJointDef();
        md.bodyA = world.GetGroundBody();
        md.bodyB = body;
        md.target.Set(mPVec2.x , mPVec2.y );
        md.collideConnected = true;
        md.maxForce = 300000.0 * body.GetMass();
        body.SetAwake(true);
        mouseJoint = world.CreateJoint(md);
		}
    if (!drawing && !dessin)
    {
        previousMouseX = mouseX;
        previousMouseY = mouseY;
        anchor = [];
        setAnchor(mouseX, mouseY);	
        drawing = true;
    }
					if (!dyna && fixe){dessin = true;}
};
	
 function onMouseUp(canvas, e) {
        if(mouseJoint) { world.DestroyJoint(mouseJoint); mouseJoint = null; }
    points.length = 0;
    drawing = false;
					dessin = false;
					ligne = false;
    if(dyna) {setAnchor(mouseX, mouseY);}
        var mPVec2 = mousePVec2(event);
	if(!(body = getBodyAtMouse(mPVec2)) && run && dyna == true && fixe == false) { audio2.play(); createBody(); }
};
	
	window.addEventListener('keyup', function(e) {
					if(e.keyCode == 37 || e.keyCode == 39) { direction = 0;	}
					});

document.addEventListener("keydown", function(event) { 
	tilt=0;
        switch (event.keyCode) {
             case 39 :	
			direction = 1;            
           break;           
            case 37 :	 
			direction = -1;
		    break;
          case 40 :	
		  if(drawcar) tilt = 1;carb.body.ApplyTorque(tiltTorque * tilt);		  
              break;            
		    case 38 :
			if(drawcar) tilt = -1;carb.body.ApplyTorque(tiltTorque * tilt);
             break;
			case 32 : 			
			//if(drawcar) {destroycar();}dddd = new CreCar(world);
             break;
          case 69 :	 //E
		  eraseline();	  
              break;    
			  case 80 :	 //P
		  	  pause();
              break;    
			  case 90 :	 //Z 
		  	  zoomOut();
              break;  
			  case 88 :	 //X 
		  	  zoomIn();
              break;  
			  case 82 :	 //R 
			  resetScene();
              break;  
			  case 65 :	 //A 
		  rigidBody.body.SetAwake(true);
		  rigidBody.body.ApplyTorque(-20)
          rigidBody.body.SetLinearVelocity(new b2Vec2(2,-5)); 
              break;  
			  case 187 :	            //+     
			 break;
            case 54 :			 //-
              break;


        } // CONTROLS 
	  
	   }, false)
	
			
 
</script>
</body>
</html>
 
 
